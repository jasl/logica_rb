<% content_for :title, "Custom query" %>

<div class="container">
  <header class="header">
    <h1>Custom query</h1>
    <nav class="nav">
      <%= link_to "Built-in reports", reports_path, class: "nav-link" %>
      <%= link_to "Custom query", new_custom_query_path, class: "nav-link" %>
    </nav>
  </header>

  <p class="muted">
    This runs <code>LogicaRb::Rails.query(source: ..., trusted: false)</code>.
    The SQL is checked as query-only (no <code>;</code>, no DDL/DML) before it hits the database.
  </p>

  <%= form_with url: custom_queries_path, method: :post, local: true do %>
    <div class="field">
      <%= label_tag :predicate, "Predicate" %>
      <%= text_field_tag :predicate, @predicate, class: "text-input" %>
    </div>

    <div class="field">
      <%= label_tag :source, "Logica source" %>
      <%= text_area_tag :source, @source, class: "code-input", rows: 18 %>
    </div>

    <%= submit_tag "Run query", class: "button" %>
  <% end %>

  <% if @error %>
    <div class="alert">
      <strong><%= @error.class.name %></strong>
      <div><%= @error.message %></div>
    </div>
  <% end %>

  <% if @sql %>
    <h2>Compiled SQL</h2>
    <pre class="code"><code><%= @sql %></code></pre>
  <% end %>

  <% if @result %>
    <h2>Result</h2>
    <%= render "shared/result_table", result: @result %>
  <% end %>
</div>
